name: PR Checks

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read
  pull-requests: read

jobs:
  # Check PR title follows conventional commit format
  pr-convention:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR Title
        uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          disallowScopes: |
            release
          subjectPattern: ^[a-z].+$
          subjectPatternError: |
            The subject "{subject}" must start with a lowercase letter.

  # Detect which services have changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.filter.outputs.changes }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            gateway-service:
              - 'gateway-service/**'
              - 'proto/**'
            metadata-service:
              - 'metadata-service/**'
              - 'proto/**'
            upload-service:
              - 'upload-service/**'
              - 'proto/**'
            streaming-service:
              - 'streaming-service/**'
              - 'proto/**'

  lint:
    needs: changes
    if: ${{ needs.changes.outputs.services != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.changes.outputs.services) }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'
          cache: true
          cache-dependency-path: ${{ matrix.service }}/go.sum

      - name: Lint ${{ matrix.service }}
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          working-directory: ${{ matrix.service }}
          args: --timeout=5m

  test:
    needs: changes
    if: ${{ needs.changes.outputs.services != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.changes.outputs.services) }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'
          cache: true
          cache-dependency-path: ${{ matrix.service }}/go.sum

      - name: Test ${{ matrix.service }}
        working-directory: ${{ matrix.service }}
        run: go test -v -race -coverprofile=coverage.out ./...

  build:
    needs: [changes, lint, test]
    if: ${{ needs.changes.outputs.services != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.changes.outputs.services) }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'
          cache: true
          cache-dependency-path: ${{ matrix.service }}/go.sum

      - name: Build ${{ matrix.service }}
        working-directory: ${{ matrix.service }}
        run: |
          if [ "${{ matrix.service }}" == "metadata-service" ]; then
            CGO_ENABLED=1 go build -tags "fts5" -v ./...
          else
            go build -v ./...
          fi
