name: PR Checks

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read
  pull-requests: read

jobs:
  # Check PR title follows conventional commit format
  pr-convention:
    name: PR Convention Check
    runs-on: ubuntu-latest
    steps:
      - name: Check PR Title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Configure which types are allowed (standard conventional commit types)
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          # Require a scope (optional - remove if not needed)
          requireScope: false
          # Disallow scopes (optional)
          disallowScopes: |
            release
          # Subject pattern validation
          subjectPattern: ^[a-z].+$
          subjectPatternError: |
            The subject "{subject}" must start with a lowercase letter.

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true
          cache-dependency-path: |
            gateway-service/go.sum
            metadata-service/go.sum
            upload-service/go.sum
            streaming-service/go.sum

      - name: Install golangci-lint
        run: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

      - name: Lint gateway-service
        working-directory: gateway-service
        run: golangci-lint run --timeout=5m

      - name: Lint metadata-service
        working-directory: metadata-service
        run: golangci-lint run --timeout=5m

      - name: Lint upload-service
        working-directory: upload-service
        run: golangci-lint run --timeout=5m

      - name: Lint streaming-service
        working-directory: streaming-service
        run: golangci-lint run --timeout=5m

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true
          cache-dependency-path: |
            gateway-service/go.sum
            metadata-service/go.sum
            upload-service/go.sum
            streaming-service/go.sum

      - name: Test gateway-service
        working-directory: gateway-service
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Test metadata-service
        working-directory: metadata-service
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Test upload-service
        working-directory: upload-service
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Test streaming-service
        working-directory: streaming-service
        run: go test -v -race -coverprofile=coverage.out ./...

  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true
          cache-dependency-path: |
            gateway-service/go.sum
            metadata-service/go.sum
            upload-service/go.sum
            streaming-service/go.sum

      - name: Build gateway-service
        working-directory: gateway-service
        run: go build -v ./...

      - name: Build metadata-service
        working-directory: metadata-service
        run: CGO_ENABLED=1 go build -tags "fts5" -v ./...

      - name: Build upload-service
        working-directory: upload-service
        run: go build -v ./...

      - name: Build streaming-service
        working-directory: streaming-service
        run: go build -v ./...
