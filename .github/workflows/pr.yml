name: PR Checks

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read
  pull-requests: read

jobs:
  # Check PR title follows conventional commit format
  pr-convention:
    name: PR Convention Check
    runs-on: ubuntu-latest
    steps:
      - name: Check PR Title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Configure which types are allowed (standard conventional commit types)
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          # Require a scope (optional - remove if not needed)
          requireScope: false
          # Disallow scopes (optional)
          disallowScopes: |
            release
          # Subject pattern validation
          subjectPattern: ^[a-z].+$
          subjectPatternError: |
            The subject "{subject}" must start with a lowercase letter.

  lint:
    name: Lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [gateway-service, metadata-service, upload-service, streaming-service]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true
          cache-dependency-path: ${{ matrix.service }}/go.sum

      - name: Lint ${{ matrix.service }}
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: ${{ matrix.service }}
          args: --timeout=5m

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [gateway-service, metadata-service, upload-service, streaming-service]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true
          cache-dependency-path: ${{ matrix.service }}/go.sum

      - name: Test ${{ matrix.service }}
        working-directory: ${{ matrix.service }}
        run: go test -v -race -coverprofile=coverage.out ./...

  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [lint, test]
    strategy:
      matrix:
        service: [gateway-service, metadata-service, upload-service, streaming-service]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true
          cache-dependency-path: ${{ matrix.service }}/go.sum

      - name: Build ${{ matrix.service }}
        working-directory: ${{ matrix.service }}
        run: |
          if [ "${{ matrix.service }}" == "metadata-service" ]; then
            CGO_ENABLED=1 go build -tags "fts5" -v ./...
          else
            go build -v ./...
          fi
